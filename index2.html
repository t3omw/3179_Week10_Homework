<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Malaysia Yearly Rainfall (2014–2020)</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #fafafa;
    }
    h2 {
      text-align: center;
      color: #003366;
    }
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    #map, #chart {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<h2>Malaysia Yearly Rainfall Trends and Distribution (2014–2020)</h2>
<div class="container">
  <div id="map"></div>
  <div id="chart"></div>
</div>

<script>
  // === Choropleth Map Spec ===
  const mapSpec = {
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 600,
  "height": 500,
  "title": {
    "text": "Yearly Rainfall by State (mm)",
    "anchor": "start",
    "fontSize": 16
  },
  "params": [
    {"name": "selectedYear", "value": 2014}
  ],
  "projection": {"type": "mercator"},
  "layer": [
    // Base map (grey outlines)
    {
      "data": {
        "url": "malaysia_state.json",
        "format": {"type": "json", "feature": "malaysia_state"}
      },
      "mark": {"type": "geoshape", "fill": "#f5f5f5", "stroke": "#999", "strokeWidth": 0.5}
    },
    // Choropleth layer (colored states)
    {
      "data": {
        "url": "malaysia_state.json",
        "format": {"type": "json", "feature": "malaysia_state"}
      },
      "transform": [
        {
          "lookup": "properties.NAME_1",      // match GeoJSON state name
          "from": {
            "data": {"url": "malaysia_rainfall_compiled_full_2014_2020.csv"},
            "key": "State",                  // match CSV "State"
            "fields": ["Year", "Yearly Rainfall (mm)"]
          }
        },
        {"filter": "datum.Year == selectedYear"}  // year slider filter
      ],
      "mark": {"type": "geoshape", "stroke": "white"},
      "encoding": {
        "color": {
          "field": "Yearly Rainfall (mm)",
          "type": "quantitative",
          "scale": {"scheme": "blues"},
          "title": "Rainfall (mm)"
        },
        "tooltip": [
          {"field": "properties.NAME_1", "title": "State"},
          {"field": "Yearly Rainfall (mm)", "type": "quantitative", "format": ",.0f"},
          {"field": "Year", "type": "ordinal"}
        ]
      }
    }
  ]
};


  // === Line Chart Spec ===
  const chartSpec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 600,
    "height": 300,
    "data": {"url": "malaysia_rainfall_compiled_full_2014_2020.csv"},
    "title": {"text": "Rainfall Trend by State (2014–2020)", "anchor": "start", "fontSize": 16},
    "params": [
      {
        "name": "state_selection",
        "value": "All States",
        "bind": {
          "input": "select",
          "options": [
            "All States", "Johor", "Kedah", "Kelantan", "Melaka",
            "Negeri Sembilan", "Pahang", "Perak", "Perlis", "Pulau Pinang",
            "Sabah", "Sarawak", "Selangor", "Terengganu",
            "Kuala Lumpur", "Labuan", "Putrajaya"
          ],
          "name": "Filter by State: "
        }
      },
      {
        "name": "year_param",
        "value": 2014,
        "bind": {"input": "range", "min": 2014, "max": 2020, "step": 1, "name": "Select Year: "}
      }
    ],
    "transform": [
      {"filter": "state_selection == 'All States' || datum.State == state_selection"}
    ],
    "mark": {"type": "line", "point": true},
    "encoding": {
      "x": {"field": "Year", "type": "ordinal", "title": "Year"},
      "y": {"field": "Yearly Rainfall (mm)", "type": "quantitative", "title": "Rainfall (mm)"},
      "color": {"field": "State", "type": "nominal", "legend": {"title": "State"}},
      "tooltip": [
        {"field": "State", "type": "nominal"},
        {"field": "Year", "type": "ordinal"},
        {"field": "Yearly Rainfall (mm)", "type": "quantitative", "format": ",.0f"}
      ]
    }
  };

  // Embed line chart first (so we can listen for its slider changes)
  vegaEmbed("#chart", chartSpec, {actions: false}).then(chartResult => {
    const chartView = chartResult.view;

    // Embed map
    vegaEmbed("#map", mapSpec, {actions: false}).then(mapResult => {
      const mapView = mapResult.view;

      // Sync slider -> map
      chartView.addSignalListener('year_param', (name, value) => {
        mapView.signal('selectedYear', value).runAsync();
      });
    });
  });
</script>
</body>
</html>
