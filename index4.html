<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Malaysia Rainfall (2014–2020)</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #fafafa; }
    h1 { text-align: center; }
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .controls { width: 220px; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .chart { flex: 1; background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    input[type=range]{ width:100%; }
    select { width:100%; padding:4px; margin-top:4px; }
  </style>
</head>
<body>
  <h1>Malaysia Rainfall (2014–2020)</h1>

  <div class="container">
    <div class="controls">
      <label><strong>Year</strong></label><br>
      <input id="year-slider" type="range" min="2014" max="2020" step="1" value="2014">
      <div style="text-align:right;font-weight:bold;">
        <span id="year-label">2014</span>
      </div>
      <hr>
      <label><strong>State</strong></label><br>
      <select id="state-select">
        <option>All States</option>
        <option>Johor</option><option>Kedah</option><option>Kelantan</option>
        <option>Kuala Lumpur</option><option>Labuan</option><option>Melaka</option>
        <option>Negeri Sembilan</option><option>Pahang</option><option>Perak</option>
        <option>Perlis</option><option>Pulau Pinang</option><option>Putrajaya</option>
        <option>Sabah</option><option>Sarawak</option><option>Selangor</option>
        <option>Terengganu</option>
      </select>
    </div>

    <div class="chart" id="map"></div>
  </div>

  <div class="chart" id="line"></div>

<script>
function parseCSV(text) {
  const [header, ...lines] = text.trim().split(/\r?\n/);
  const cols = header.split(',');
  return lines.map(l => {
    const vals = l.split(',');
    const obj = {};
    cols.forEach((c, i) => obj[c] = vals[i]);
    return obj;
  });
}

let perSqkm = [], yearly = [];

async function loadData() {
  const [csv1, csv2] = await Promise.all([
    fetch('malaysia_rainfall_per_sqkm.csv').then(r=>r.text()),
    fetch('malaysia_rainfall_compiled_full_2014_2020_scaled.csv').then(r=>r.text())
  ]);
  perSqkm = parseCSV(csv1).map(r=>({
    State: r.State,
    Year: +r.Year,
    RainfallPerKm2: +r["Yearly Rainfall (mm/km^2)"]
  }));
  yearly = parseCSV(csv2).map(r=>({
    State: r.State,
    Year: +r.Year,
    Rainfall: +r["Yearly Rainfall (mm)"]
  }));
}

function getMapValues(year) {
  return perSqkm.filter(r => r.Year === year)
                .map(r => ({ State: r.State, rainfall: r.RainfallPerKm2 }));
}

function getLineValues(year, state) {
  const filtered = yearly.filter(r => r.Year <= year);
  if (state !== 'All States') return filtered.filter(r => r.State === state);
  return filtered;
}

async function render() {
  const year = +document.getElementById('year-slider').value;
  const state = document.getElementById('state-select').value;
  document.getElementById('year-label').textContent = year;

  const mapValues = getMapValues(year);

  // === MAP SPEC ===
  const mapSpec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 750,
    "height": 600,
    "projection": {"type":"mercator", "center":[109.5,4], "scale":2200},
    "layer": [
      {
        "data": {"url":"malaysia_state.json","format":{"type":"topojson","feature":"malaysia_state"}},
        "mark":{"type":"geoshape","fill":"#f2f2f2","stroke":"#ccc"}
      },
      {
        "data": {"url":"malaysia_state.json","format":{"type":"topojson","feature":"malaysia_state"}},
        "transform":[
          {
            "lookup": "properties.NAME_1",
            "from": {"data":{"values": mapValues},"key":"State","fields":["rainfall"]}
          }
        ],
        "mark":{"type":"geoshape","stroke":"white"},
        "encoding":{
          "color":{
            "field":"rainfall",
            "type":"quantitative",
            "scale":{"type":"log","scheme":"blues"},
            "title":"Yearly Rainfall (mm/km²)"
          },
          "tooltip":[
            {"field":"properties.NAME_1","title":"State"},
            {"field":"rainfall","format":".3f","title":"Rainfall (mm/km²)"}
          ]
        }
      }
    ]
  };

  // === LINE CHART SPEC ===
  const lineValues = getLineValues(year, state);
  const lineSpec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 900,
    "height": 350,
    "data": {"values": lineValues},
    "mark":{"type":"line","point":true,"interpolate":"monotone"},
    "encoding":{
      "x":{"field":"Year","type":"ordinal","title":"Year"},
      "y":{"field":"Rainfall","type":"quantitative","title":"Yearly Rainfall (mm)"},
      "color":{"field":"State","type":"nominal","legend":{"title":"State"}},
      "opacity":{
        "condition":{"test": state === 'All States' ? "true" : `datum.State === '${state}'`, "value":1},
        "value": state === 'All States' ? 0.4 : 0.1
      },
      "tooltip":[{"field":"State"},{"field":"Year"},{"field":"Rainfall","format":".1f"}]
    }
  };

  await vegaEmbed('#map', mapSpec, {actions:false});
  await vegaEmbed('#line', lineSpec, {actions:false});
}

(async function(){
  await loadData();
  document.getElementById('year-slider').addEventListener('input', render);
  document.getElementById('state-select').addEventListener('change', render);
  render();
})();
</script>
</body>
</html>
